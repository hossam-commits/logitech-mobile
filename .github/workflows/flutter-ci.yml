name: Flutter CI/CD Pipeline

on:
  push:
    branches: [ main, master, develop, ci/add-flutter-checks ]
  pull_request:
    branches: [ main, master, develop, ci/add-flutter-checks ]

jobs:
  # -----------------------------------------------------------------
  # Job 1: Quality Checks (Tests & Analysis)
  # -----------------------------------------------------------------
  quality_checks:
    name: Quality Checks (Analyze & Test)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.29.0'
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      # [NEW STEP] Create .env file for Tests
      # This is crucial so tests running with AppConfig can find values
      - name: Create .env file from Secrets
        run: |
          echo "API_KEY=${{ secrets.API_KEY }}" > .env
          echo "FIREBASE_PROJECT_ID=${{ secrets.FIREBASE_PROJECT_ID }}" >> .env
          echo "USE_MOCK_DATA=true" >> .env 
          # Note: We enforce Mock Data = true for unit tests usually, or use secrets.USE_MOCK_DATA

      - name: Auto-format Dart code
        run: dart format .

      - name: Run Flutter Analyze
        run: flutter analyze --fatal-infos

      - name: Check Formatting
        run: dart format --set-exit-if-changed .

      # Updated: Pass .env to tests
      - name: Run Tests
        run: flutter test --coverage --dart-define-from-file=.env

      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage/lcov.info
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

  # -----------------------------------------------------------------
  # Job 2: Build APK (Release Version)
  # -----------------------------------------------------------------
  build_apk:
    name: Build Release APK
    needs: quality_checks # Only run if tests pass
    runs-on: ubuntu-latest
    if: github.event_name == 'push' # Only build on push (not PRs) to save resources

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.29.0'
          channel: 'stable'
          cache: true
      
      - name: Install dependencies
        run: flutter pub get

      # [NEW STEP] Create .env file for Production Build
      - name: Create .env file from Secrets
        run: |
          echo "API_KEY=${{ secrets.API_KEY }}" > .env
          echo "FIREBASE_PROJECT_ID=${{ secrets.FIREBASE_PROJECT_ID }}" >> .env
          echo "USE_MOCK_DATA=false" >> .env 
          # Note: For release build, we force Mock Data to FALSE (Production Mode)

      - name: Build APK (Release)
        run: flutter build apk --release --dart-define-from-file=.env

      # Upload the APK so you can download it from GitHub Actions page
      - name: Upload Release APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: build/app/outputs/flutter-apk/app-release.apk
